<!doctype html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="description" content="Desafio de adivinha√ß√£o com sistema de penalidade temporal. Teste suas habilidades de dedu√ß√£o!" />
        <meta name="theme-color" content="#4f46e5" />
        <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéØ</text></svg>">
        <title>Desafio de Adivinha√ß√£o Cronometrado</title>

        <script>
            // --- URL PARAMETER PARSER ---
            function getAnswerFromURL() {
                const urlParams = new URLSearchParams(window.location.search);
                const encodedAnswer = urlParams.get("id");

                if (!encodedAnswer) {
                    return null; // No parameter provided
                }

                try {
                    // Decode from Base64
                    const decodedAnswer = atob(encodedAnswer);
                    return decodedAnswer;
                } catch (e) {
                    console.error("Invalid id parameter:", e);
                    return null; // Invalid Base64
                }
            }

            // --- SESSION MANAGEMENT ---
            const SESSION_KEY = "guessingGameSession";
            let userSession = null;

            function getExistingSession() {
                const existingSession = localStorage.getItem(SESSION_KEY);
                if (existingSession) {
                    return JSON.parse(existingSession);
                }
                return null;
            }

            function createSession(userName) {
                const session = {
                    name: userName.trim(),
                    id:
                        Date.now() +
                        "_" +
                        Math.random().toString(36).substring(2, 9),
                    createdAt: Date.now(),
                };
                localStorage.setItem(SESSION_KEY, JSON.stringify(session));
                return session;
            }

            function showNameModal() {
                const modal = document.getElementById("nameModal");
                const nameInput = document.getElementById("nameInput");
                const nameSubmit = document.getElementById("nameSubmit");
                const nameError = document.getElementById("nameError");

                modal.classList.remove("hidden");
                nameInput.focus();

                function handleSubmit() {
                    const userName = nameInput.value.trim();
                    if (!userName) {
                        nameError.textContent = "Por favor, digite seu nome.";
                        nameError.classList.remove("hidden");
                        nameInput.focus();
                        return;
                    }

                    // Create session and hide modal
                    userSession = createSession(userName);
                    modal.classList.add("hidden");

                    // Initialize the game now that we have a session
                    initializeGame();
                }

                function handleKeyPress(e) {
                    if (e.key === "Enter") {
                        handleSubmit();
                    } else if (e.key === "Escape") {
                        // Clear error on ESC
                        nameError.classList.add("hidden");
                    }
                }

                nameSubmit.addEventListener("click", handleSubmit);
                nameInput.addEventListener("keypress", handleKeyPress);

                // Close modal on ESC key
                document.addEventListener("keydown", function(e) {
                    if (e.key === "Escape" && !modal.classList.contains("hidden")) {
                        nameError.classList.add("hidden");
                    }
                });
            }

            // Check for existing session on load
            userSession = getExistingSession();

            // --- CONSTANTES DO JOGO ---
            const CORRECT_ANSWER = getAnswerFromURL();

            // Validate that answer parameter exists
            if (!CORRECT_ANSWER) {
                document.body.innerHTML = `
          <div style="display: flex; justify-content: center; align-items: center;
                      min-height: 100vh; text-align: center; font-family: sans-serif;">
            <div>
              <h1 style="color: #dc2626; font-size: 2rem; margin-bottom: 1rem;">‚ùå Erro</h1>
              <p style="color: #6b7280; font-size: 1.125rem; margin-bottom: 0.5rem;">Esta p√°gina requer um c√≥digo de acesso v√°lido.</p>
              <p style="color: #9ca3af; font-size: 0.875rem;">Entre em contato com o administrador.</p>
            </div>
          </div>
        `;
                throw new Error("No valid answer parameter provided");
            }

            const PENALTY_INCREMENT_MS = 5 * 60 * 1000; // 5 minutos em milissegundos

            // --- UI ELEMENTS ---
            let inputElement;
            let submitButton;
            let messageElement;
            let countdownElement;

            // --- ESTADO DO JOGO ---
            let penaltyDurationMs = 0; // Tempo total de penalidade acumulada
            let lastAttemptTimestamp = 0; // Timestamp (ms) da √∫ltima tentativa falha
            let countdownInterval;

            // Utility function to convert milliseconds to HH:MM:SS format
            function msToTime(duration) {
                let seconds = Math.floor((duration / 1000) % 60);
                let minutes = Math.floor((duration / (1000 * 60)) % 60);
                let hours = Math.floor((duration / (1000 * 60 * 60)) % 24);

                hours = hours < 10 ? "0" + hours : hours;
                minutes = minutes < 10 ? "0" + minutes : minutes;
                seconds = seconds < 10 ? "0" + seconds : seconds;

                return hours + ":" + minutes + ":" + seconds;
            }

            // --- FUN√á√ïES DE ARMAZENAMENTO LOCAL (LOCALSTORAGE) ---

            function getStorageKey() {
                return `guessingGamePenalty_${userSession.id}`;
            }

            function loadGameState() {
                const storedState = localStorage.getItem(getStorageKey());
                if (storedState) {
                    try {
                        const data = JSON.parse(storedState);
                        penaltyDurationMs = data.penaltyDurationMs || 0;
                        lastAttemptTimestamp = data.lastAttemptTimestamp || 0;
                        console.log(
                            "Estado do jogo carregado do LocalStorage.",
                        );
                    } catch (e) {
                        console.error(
                            "Erro ao carregar estado do LocalStorage:",
                            e,
                        );
                        localStorage.removeItem(getStorageKey()); // Limpa estado corrompido
                    }
                }
            }

            function saveGameState() {
                const data = {
                    penaltyDurationMs: penaltyDurationMs,
                    lastAttemptTimestamp: Date.now(),
                };
                localStorage.setItem(getStorageKey(), JSON.stringify(data));
                lastAttemptTimestamp = data.lastAttemptTimestamp; // Atualiza o estado local
                console.log("Estado do jogo salvo no LocalStorage.");
            }

            function resetGameState() {
                localStorage.removeItem(getStorageKey());
                penaltyDurationMs = 0;
                lastAttemptTimestamp = 0;
                console.log("Estado do jogo redefinido.");
            }

            // --- UI AND GAME LOGIC ---

            function createConfetti() {
                // Check if user prefers reduced motion
                if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                    // Show static celebration instead
                    messageElement.style.animation = 'pulse 0.5s ease';
                    setTimeout(() => {
                        messageElement.style.animation = '';
                    }, 500);
                    return;
                }

                const confettiContainer = document.createElement("div");
                confettiContainer.className = "confetti-container";
                document.body.appendChild(confettiContainer);

                const colors = [
                    "#ff0000",
                    "#00ff00",
                    "#0000ff",
                    "#ffff00",
                    "#ff00ff",
                    "#00ffff",
                    "#ffa500",
                    "#ff1493",
                ];
                const confettiCount = 150;

                for (let i = 0; i < confettiCount; i++) {
                    const confetti = document.createElement("div");
                    confetti.className = "confetti";
                    confetti.style.left = Math.random() * 100 + "%";
                    confetti.style.backgroundColor =
                        colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDelay = Math.random() * 0.5 + "s";
                    confetti.style.animationDuration =
                        Math.random() * 2 + 2 + "s";
                    confetti.style.willChange = "transform";
                    confettiContainer.appendChild(confetti);
                }

                // Remove confetti after animation
                setTimeout(() => {
                    confettiContainer.remove();
                }, 5000);
            }

            function updateCountdown() {
                const now = Date.now();
                const unlockTime = lastAttemptTimestamp + penaltyDurationMs;
                const remainingMs = unlockTime - now;

                if (remainingMs <= 0) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                    // Habilita input e bot√£o
                    inputElement.disabled = false;
                    inputElement.removeAttribute('aria-disabled');
                    submitButton.disabled = false;
                    submitButton.removeAttribute('aria-disabled');
                    countdownElement.classList.add("hidden");
                    messageElement.textContent =
                        "‚úÖ Entrada reativada! Digite seu pr√≥ximo palpite.";
                    inputElement.focus();
                    return;
                }

                // A contagem ainda est√° em andamento (penalizado)
                inputElement.disabled = true;
                inputElement.setAttribute('aria-disabled', 'true');
                submitButton.disabled = true;
                submitButton.setAttribute('aria-disabled', 'true');
                countdownElement.classList.remove("hidden");

                const timeString = msToTime(remainingMs);
                countdownElement.textContent = `Reativar em: ${timeString}`;
                messageElement.textContent = `‚è±Ô∏è Aguarde o fim do cron√¥metro antes de tentar novamente.`;
            }

            function updateUI() {
                if (countdownInterval) {
                    clearInterval(countdownInterval);
                }

                const now = Date.now();
                const unlockTime = lastAttemptTimestamp + penaltyDurationMs;

                if (unlockTime > now) {
                    // Inicia contagem regressiva
                    countdownInterval = setInterval(updateCountdown, 1000);
                    updateCountdown(); // Chama imediatamente para evitar 1 segundo de atraso
                } else {
                    // N√£o penalizado, habilita tudo
                    inputElement.disabled = false;
                    inputElement.removeAttribute('aria-disabled');
                    submitButton.disabled = false;
                    submitButton.removeAttribute('aria-disabled');
                    countdownElement.classList.add("hidden");
                    messageElement.textContent = `Digite seu palpite.`;
                }
            }

            function handleSubmit() {
                if (inputElement.disabled) {
                    messageElement.className = "warning";
                    messageElement.textContent =
                        "‚è±Ô∏è Aguarde o fim do cron√¥metro antes de tentar novamente.";
                    return;
                }

                const guess = inputElement.value.trim();

                // Validate empty input
                if (guess === "") {
                    messageElement.className = "warning";
                    messageElement.textContent = "‚ö†Ô∏è Por favor, digite um palpite antes de enviar.";
                    inputElement.focus();
                    return;
                }

                inputElement.value = ""; // Limpa o input ap√≥s valida√ß√£o

                if (guess.toLowerCase() === CORRECT_ANSWER.toLowerCase()) {
                    // --- RESPOSTA CORRETA ---
                    // Clear any running countdown interval first
                    if (countdownInterval) {
                        clearInterval(countdownInterval);
                        countdownInterval = null;
                    }

                    messageElement.className = "success";
                    messageElement.textContent =
                        "üéâ Parab√©ns! Voc√™ adivinhou a resposta correta!";

                    // Trigger confetti animation
                    createConfetti();

                    // Redefine o estado de penalidade (LocalStorage)
                    resetGameState();

                    // Enable input and hide countdown without changing the success message
                    inputElement.disabled = false;
                    inputElement.removeAttribute('aria-disabled');
                    submitButton.disabled = false;
                    submitButton.removeAttribute('aria-disabled');
                    countdownElement.classList.add("hidden");
                } else {
                    // --- RESPOSTA INCORRETA ---
                    messageElement.className = "error";
                    messageElement.textContent =
                        "‚ùå Resposta incorreta. Aguarde o cron√¥metro para tentar novamente.";

                    // Aumenta a penalidade e salva o estado
                    penaltyDurationMs += PENALTY_INCREMENT_MS;
                    saveGameState();

                    // Inicia nova contagem regressiva
                    updateUI();
                }
            }

            function initializeGame() {
                // Associa elementos da UI
                inputElement = document.getElementById("guessInput");
                submitButton = document.getElementById("submitButton");
                messageElement = document.getElementById("messageDisplay");
                countdownElement = document.getElementById("countdownDisplay");

                // Display welcome message with user's name
                document.getElementById("userName").textContent =
                    userSession.name;

                // Carrega estado do LocalStorage
                loadGameState();

                // Configura listeners
                submitButton.addEventListener("click", handleSubmit);
                inputElement.addEventListener("keypress", function (e) {
                    if (e.key === "Enter") {
                        handleSubmit();
                    }
                });

                // Atualiza a interface (inicia o contador se necess√°rio)
                updateUI();
            }

            // Inicializa tudo quando a janela carrega
            window.onload = function() {
                if (!userSession) {
                    // Show name modal for new users
                    showNameModal();
                } else {
                    // Existing user - initialize game directly
                    initializeGame();
                }
            };
        </script>

        <style>
            html {
                box-sizing: border-box;
            }

            *,
            *::before,
            *::after {
                box-sizing: inherit;
                margin: 0;
                padding: 0;
            }

            body {
                font-family:
                    "Inter",
                    -apple-system,
                    BlinkMacSystemFont,
                    "Segoe UI",
                    Roboto,
                    sans-serif;
                background-color: #f3f4f6;
                min-height: 100dvh;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                padding: 1rem;
            }

            .container {
                width: 100%;
                max-width: 32rem;
                background-color: white;
                padding: 2rem;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                border-radius: 0.75rem;
                text-align: center;
            }

            @media (min-width: 768px) {
                .container {
                    padding: 2.5rem;
                }
            }

            h1 {
                font-size: 1.875rem;
                font-weight: 800;
                color: #1f2937;
                margin-bottom: 1rem;
            }

            .subtitle {
                color: #6b7280;
                margin-bottom: 1rem;
            }

            .welcome {
                color: #4f46e5;
                font-weight: 600;
                margin-bottom: 1.5rem;
            }

            /* Confetti Animation */
            .confetti {
                position: fixed;
                width: 10px;
                height: 10px;
                background-color: #f0f;
                animation: confetti-fall 3s linear forwards;
            }

            @keyframes confetti-fall {
                to {
                    transform: translateY(100vh) rotate(360deg);
                    opacity: 0;
                }
            }

            .confetti-container {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                pointer-events: none;
                z-index: 9999;
            }

            #messageDisplay {
                font-size: 1.25rem;
                font-weight: 600;
                color: #374151;
                margin-bottom: 1.5rem;
                min-height: 3rem;
            }

            #messageDisplay.success {
                font-size: 1.5rem;
                font-weight: 700;
                color: #16a34a;
            }

            #messageDisplay.error {
                font-size: 1.5rem;
                font-weight: 700;
                color: #dc2626;
            }

            #messageDisplay.warning {
                font-size: 1.25rem;
                font-weight: 600;
                color: #d97706;
            }

            #countdownDisplay {
                font-size: 1.875rem;
                font-family: monospace;
                color: #991b1b;
                background-color: #fee2e2;
                padding: 1rem;
                border-radius: 0.5rem;
                margin-bottom: 1.5rem;
                box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
            }

            #countdownDisplay.hidden {
                display: none;
            }

            .input-group {
                display: flex;
                flex-direction: column;
                gap: 1rem;
            }

            #guessInput {
                flex-grow: 1;
                padding: 1rem;
                border: 2px solid #a5b4fc;
                border-radius: 0.5rem;
                font-size: 1.125rem;
                text-align: center;
                transition: all 150ms;
                outline: none;
            }

            #guessInput:focus {
                outline: none;
                border-color: #4f46e5;
                box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.5);
            }

            #guessInput:disabled {
                background-color: #f9fafb;
                color: #9ca3af;
                cursor: not-allowed;
            }

            #submitButton {
                padding: 1rem 1.5rem;
                background-color: #4f46e5;
                color: white;
                font-weight: 700;
                border: none;
                border-radius: 0.5rem;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                cursor: pointer;
                transition: all 150ms;
            }

            #submitButton:hover:not(:disabled) {
                background-color: #4338ca;
                transform: scale(1.02);
            }

            #submitButton:disabled {
                background-color: #9ca3af;
                box-shadow: none;
                cursor: not-allowed;
                transform: none;
            }

            #submitButton:focus-visible {
                outline: 3px solid #4f46e5;
                outline-offset: 2px;
            }

            #submitButton:focus:not(:focus-visible) {
                outline: none;
            }

            .visually-hidden {
                position: absolute;
                width: 1px;
                height: 1px;
                margin: -1px;
                padding: 0;
                overflow: hidden;
                clip: rect(0, 0, 0, 0);
                white-space: nowrap;
                border-width: 0;
            }

            /* Modal Styles */
            .modal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            }

            .modal.hidden {
                display: none;
            }

            .modal-content {
                background-color: white;
                padding: 2rem;
                border-radius: 0.75rem;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
                max-width: 400px;
                width: 90%;
                text-align: center;
            }

            .modal-content h2 {
                color: #1f2937;
                margin-bottom: 1.5rem;
                font-size: 1.5rem;
            }

            .modal-content label {
                display: block;
                color: #374151;
                margin-bottom: 0.5rem;
                font-weight: 600;
                text-align: left;
            }

            .modal-content input {
                width: 100%;
                padding: 0.75rem;
                border: 2px solid #a5b4fc;
                border-radius: 0.5rem;
                font-size: 1rem;
                margin-bottom: 1rem;
                outline: none;
            }

            .modal-content input:focus {
                border-color: #4f46e5;
                box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.5);
            }

            .modal-content button {
                width: 100%;
                padding: 0.75rem 1.5rem;
                background-color: #4f46e5;
                color: white;
                font-weight: 700;
                border: none;
                border-radius: 0.5rem;
                cursor: pointer;
                font-size: 1rem;
                transition: background-color 150ms;
            }

            .modal-content button:hover {
                background-color: #4338ca;
            }

            .modal-content button:focus-visible {
                outline: 3px solid #4f46e5;
                outline-offset: 2px;
            }

            .name-error {
                color: #dc2626;
                font-size: 0.875rem;
                margin-top: 0.5rem;
            }

            .name-error.hidden {
                display: none;
            }

            .skip-link {
                position: absolute;
                top: -40px;
                left: 0;
                background: #4f46e5;
                color: white;
                padding: 8px;
                text-decoration: none;
                z-index: 100;
            }

            .skip-link:focus {
                top: 0;
            }

            @keyframes pulse {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.05); }
            }
        </style>
    </head>

    <body>
        <a href="#guessInput" class="skip-link">Pular para o campo de palpite</a>

        <!-- Name Modal -->
        <div id="nameModal" class="modal hidden" role="dialog" aria-labelledby="nameModalTitle" aria-modal="true">
            <div class="modal-content">
                <h2 id="nameModalTitle">Bem-vindo!</h2>
                <label for="nameInput">Por favor, digite seu nome:</label>
                <input type="text" id="nameInput" required aria-required="true" />
                <button id="nameSubmit">Continuar</button>
                <p id="nameError" class="name-error hidden" role="alert"></p>
            </div>
        </div>

        <div class="container">
            <h1>O Desafio de Adivinha√ß√£o</h1>
            <p class="subtitle">
                Adivinhe a resposta secreta! Cada resposta incorreta adiciona 5 minutos de espera.
            </p>

            <!-- Welcome Message -->
            <p id="welcomeMessage" class="welcome">
                Bem-vindo, <span id="userName"></span>!
            </p>

            <!-- Message/Status Display -->
            <div
                id="messageDisplay"
                role="status"
                aria-live="polite"
                aria-atomic="true"
            >
                Carregando estado do jogo...
            </div>

            <!-- Countdown Timer -->
            <div
                id="countdownDisplay"
                class="hidden"
                role="timer"
                aria-live="polite"
                aria-atomic="true"
            >
                Reativar em: 00:00:00
            </div>

            <!-- Input and Button Group -->
            <div class="input-group">
                <label for="guessInput" class="visually-hidden">Digite seu palpite</label>
                <input
                    type="text"
                    id="guessInput"
                    placeholder="Digite seu palpite"
                    maxlength="5"
                    inputmode="numeric"
                    aria-label="Campo de palpite"
                    aria-describedby="messageDisplay"
                    aria-required="true"
                    disabled
                />
                <button id="submitButton" disabled>
                    Enviar Palpite
                </button>
            </div>
        </div>
    </body>
</html>
